<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Dashboard</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
</head>
<body class="bg-light">

  <!-- Navbar -->
  <nav class="navbar navbar-expand-lg navbar-dark bg-dark">
    <div class="container-fluid">
      <a class="navbar-brand" href="#">MySite</a>
      <div>
        <a href="dashboard.html" class="btn btn-outline-light active">Dashboard</a>
        <button class="btn btn-danger ms-3" id="logoutBtn">Logout</button>
      </div>
    </div>
  </nav>

  <div class="container text-center mt-5">
    <div class="card shadow p-5">
      <h2>Welcome to your Dashboard ðŸš€</h2>
      <p class="lead mt-3" id="userInfo">Loading user information...</p>
    </div>
  </div>

  <script>
    // Utility function to refresh token
    async function refreshToken() {
      const refresh_token = localStorage.getItem('refresh_token');
      if (!refresh_token) {
        window.location.href = 'index.html';
        return null;
      }

      try {
        const response = await fetch('https://ladogudi.serv00.net/api/refresh', {
          method: 'POST',
          headers: { 'Authorization': `Bearer ${refresh_token}` }
        });
        const data = await response.json();

        if (response.ok) {
          localStorage.setItem('access_token', data.access_token);
          return data.access_token;
        } else {
          localStorage.clear();
          window.location.href = 'index.html';
          return null;
        }
      } catch (error) {
        localStorage.clear();
        window.location.href = 'index.html';
        return null;
      }
    }

    // Utility function to fetch profile
    async function fetchProfile() {
      let access_token = localStorage.getItem('access_token');
      if (!access_token) {
        window.location.href = 'index.html';
        return;
      }

      try {
        let response = await fetch('https://ladogudi.serv00.net/api/profile', {
          method: 'GET',
          headers: { 'Authorization': `Bearer ${access_token}` }
        });

        if (response.status === 401) {
          access_token = await refreshToken();
          if (!access_token) return;

          response = await fetch('https://ladogudi.serv00.net/api/profile', {
            method: 'GET',
            headers: { 'Authorization': `Bearer ${access_token}` }
          });
        }

        const data = await response.json();
        if (response.ok) {
          document.getElementById('userInfo').textContent = `Welcome, ${data.email}! (ID: ${data.id})`;
        } else {
          document.getElementById('userInfo').textContent = 'Failed to load user information.';
        }
      } catch (error) {
        document.getElementById('userInfo').textContent = 'Network error. Please try again.';
      }
    }

    // Handle Logout
    document.getElementById('logoutBtn').addEventListener('click', async () => {
      const access_token = localStorage.getItem('access_token');
      if (!access_token) {
        localStorage.clear();
        window.location.href = 'index.html';
        return;
      }

      try {
        const response = await fetch('https://ladogudi.serv00.net/api/logout', {
          method: 'POST',
          headers: { 'Authorization': `Bearer ${access_token}` }
        });
        localStorage.clear();
        window.location.href = 'index.html';
      } catch (error) {
        localStorage.clear();
        window.location.href = 'index.html';
      }
    });

    // Check if logged in and fetch profile
    if (!localStorage.getItem('access_token')) {
      window.location.href = 'index.html';
    } else {
      fetchProfile();
    }
  </script>
</body>
</html>